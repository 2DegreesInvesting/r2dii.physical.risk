---
title: "Physical Risk Methodology"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{physical-risk-methodology}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(dplyr)
library(r2dii.physical.risk)
```

This article documents the methodology used in this repository to estimate
the risk a financial portfolio incurs as a result of changing physical hazards, 
caused by climate change. The article assumes a working understanding of PACTA. 

# Data

First, we will give a brief overview of the crucial datasets used. 

## Input Portfolio
A typical "input portfolio" to PACTA looks something like this: 

``` {r}
portfolio <- tibble::tribble(
  ~isin, ~market_value, ~currency,
  "JP3868400007",       50000L,     "GBP",
  "FR0000571218",       28136L,     "GBP",
  "FR0011883966",      117291L,     "GBP"
)

portfolio

```

The input portfolio that is actually used in the physical risk assessment is
already slightly pre-processed. The file used is the `total_portfolio.rda` file
that can be found in the folder `30_Processed_Inputs` of a typical PACTA
project. What this means is that it has already been extended using financial
data, and contains some columns that are not present in the above dataset.
Crucially, it contains the following columns:

``` {r}
portfolio <- tibble::tribble(
  ~portfolio_name,    ~company_name, ~company_id, ~corporate_bond_ticker,          ~isin, ~holding_id, ~asset_type, ~security_mapped_sector, ~value_usd,
  "some portfolio", "some wind farm",          "C5",                  "ABC", "AB1234567890",        123L,    "Equity",                 "Power",     45000L
)

portfolio
```

## Financial Data
Further financial data is used to understand the company ownership structure of 
any company in the portfolio. The goal is to be able to link each company that 
is present in the portfolio, all the way down to the individual physical assets 
that it might own and operate. 

First, we need to understand which companies own the individual asset:

``` {r}
asset_level_owners <- tibble::tribble(
  ~company_id,        ~asset_id, ~ownership_share,
  "C1",    "A1",              25,
  "C2",    "A1",              25,
  "C3",  "A1",                50
)

asset_level_owners

```

In this case, we see that the power plant with ID `"A1"` is jointly owned by 
companies with IDs `c("C1", "C2", "C3")`. 

However, the only company in the portfolio (above) has the ID `"C5"`? We will 
see below that this company owns a stake of the above company. 

To understand this, we need a dataset indicating the corporate ownership 
structure of each physical asset-owning company. This dataset looks something 
like this: 

``` {r}
company_ownership_tree <- tibble::tribble(
  ~company_id, ~subsidiary_id, ~linking_stake, ~ownership_level,
          "C5",         "C1",             50,                2,
          "C6",         "C1",             50,                2,
          "C5",         "C3",             100,                2
  )
```


## Physical Assets

The physical asset data used looks something like this: 

```{r}
ald <- tibble::tribble(
  ~asset_name, ~asset_location, ~latitude, ~longitude, ~sector,     ~technology, ~year, ~economic_unit, ~economic_output, ~asset_id,
  "Some Wind Farm",            "ES",       42L,        -3L, "Power", "RenewablesCap", 2020L,           "MW",             400L,      "A1",
  "Some Wind Farm",            "ES",       42L,        -3L, "Power", "RenewablesCap", 2021L,           "MW",             420L,      "A1",
  "Some Wind Farm",            "ES",       42L,        -3L, "Power", "RenewablesCap", 2022L,           "MW",             440L,      "A1"
)

ald
```

This data contains physical assets, including geographic latitude and longitude
coordinates, for a variety of sectors, as well as production or capacity values 
for each asset. 

## Climate Hazard Scenarios 
### Climate Analytics

Climate data is "pre-processed", and harmonized with the physical asset data. 
For each combination of asset, scenario, model, period and hazard, there is an 
associated `relative_change` value. This value represents the estimated relative 
difference in the hazard (e.g. expected preciptation):

```{r}
climate_data <- tibble::tribble(
       ~asset_name, ~scenario,     ~model, ~period,    ~hazard, ~relative_change,
  "Some Wind Farm",   "rcp26", "Ensemble",   2100L, "prAdjust",            0.004,
  "Some Wind Farm",   "rcp45", "Ensemble",   2100L, "prAdjust",             0.03,
  "Some Wind Farm",   "rcp60", "Ensemble",   2100L, "prAdjust",             0.04
  )

climate_data
```

# Methodology

The process to estimate the portfolio's exposure to various physical hazards is
as follows:

- Individual physical assets are linked to each company in their corporate 
ownership structure 
- Production/ Capacity of each asset is divided amongst immediate asset owners 
by their ownership stake
- Production/ Capacity is propagated up the corporate ownership tree by the 
linking stake of each company
- Formatted climate data is linked to each individual asset
- Combined "climate data" and "physical asset data" is linked to the portfolio 
(based on either the `company_id` for equity, or `corporate_bond_ticker` for 
bonds)
- Exposure to each asset is estimated as either the `ownership_weight` or 
`portfolio_weight` multiplied by the economic_value associated with the asset 
(either "production" or "capacity")
- Physical risk exposure is indicated by the "amount" of each economic exposure 
indicator that falls into each "relative_change" bin. Histograms can be drawn, 
indicating where the majority of exposure in various sectors is in comparison to 
the risk indicator chosen. 
